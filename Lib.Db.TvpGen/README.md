# Lib.Db.TvpGen

**ê³ ì„±ëŠ¥ TVP ë° DbDataReader ë§¤í•‘ ì½”ë“œ ìë™ ìƒì„±ê¸° (Track 5 Optimized)**

<!-- AI_CONTEXT: START -->
<!-- AGENT_NOTE: ì´ ìƒë‹¨ ì„¹ì…˜ì€ AI ì—ì´ì „íŠ¸ê°€ ì´ ë¼ì´ë¸ŒëŸ¬ë¦¬ë¥¼ ì´í•´í•˜ê³  ì‘ì—…í•˜ê¸° ìœ„í•œ í•µì‹¬ ê·œì¹™ì…ë‹ˆë‹¤. -->
<!-- RULE: NO_REFLECTION_RUNTIME > ëŸ°íƒ€ì„ ë¦¬í”Œë ‰ì…˜ì„ ì‚¬ìš©í•˜ì§€ ë§ê³ , ìƒì„±ëœ TvpRegistry/DbResult ì½”ë“œë¥¼ ì‹ ë¢°í•˜ì‹­ì‹œì˜¤. -->
<!-- RULE: FULLY_QUALIFIED_STRICT > ëª¨ë“  íƒ€ì…ì€ global:: ë„¤ì„ìŠ¤í˜ì´ìŠ¤ë¥¼ í¬í•¨í•œ ì™„ì „ ìˆ˜ì‹ëª…(FullyQualified)ìœ¼ë¡œ ê¸°ìˆ ë©ë‹ˆë‹¤. -->
<!-- RULE: CHECK_OBJ_FOLDER > ìƒì„±ëœ ì½”ë“œëŠ” obj/Debug/net10.0/generated/... ê²½ë¡œì— ìœ„ì¹˜í•©ë‹ˆë‹¤. ë””ë²„ê¹… ì‹œ ì´ê³³ì„ ì°¸ì¡°í•˜ì‹­ì‹œì˜¤. -->
<!-- AI_CONTEXT: END -->

[![.NET](https://img.shields.io/badge/.NET-10%2B-512BD4)](https://dotnet.microsoft.com/)
[![SQL Server](https://img.shields.io/badge/SQL%20Server-2008%2B-CC2927)](https://www.microsoft.com/sql-server)
[![License](https://img.shields.io/badge/License-MIT-blue.svg)](LICENSE)

---

## âš¡ ê°œìš” (Overview)

`Lib.Db.TvpGen`ì€ **Roslyn Source Generator**ë¥¼ í™œìš©í•˜ì—¬ SQL Server Table-Valued Parameters (TVP)ì™€ DbDataReader ê²°ê³¼ ë§¤í•‘ ì½”ë“œë¥¼ ì»´íŒŒì¼ íƒ€ì„ì— ìë™ ìƒì„±í•©ë‹ˆë‹¤. **v2.0 'Quantum Leap'** ì—…ë°ì´íŠ¸ë¥¼ í†µí•´ ëŸ°íƒ€ì„ ì˜¤ë²„í—¤ë“œë¥¼ ì œë¡œí™”í•˜ê³ , **Track 5 í•˜ì´ë¸Œë¦¬ë“œ ì•Œê³ ë¦¬ì¦˜**ì„ ë„ì…í•˜ì—¬ ê·¹í•œì˜ ì„±ëŠ¥ì„ ì œê³µí•©ë‹ˆë‹¤.

### ğŸš€ í•µì‹¬ ê¸°ëŠ¥ (v2.0)

1.  **Track 5 Hybrid Algorithm**:
    *   **Small (â‰¤12)**: `Span.SequenceEqual` ê¸°ë°˜ì˜ ê³ ì† `else-if` ë¶„ê¸°.
    *   **Large (>12)**: `FNV-1a` í•´ì‹œ ê¸°ë°˜ì˜ `switch` ë¶„ê¸° (O(1) ê·¼ì ‘).
2.  **Zero Runtime Overhead**: ë¦¬í”Œë ‰ì…˜, ë°•ì‹±/ì–¸ë°•ì‹±, ë”•ì…”ë„ˆë¦¬ ë£©ì—…ì„ ì™„ì „íˆ ì œê±°í–ˆìŠµë‹ˆë‹¤.
3.  **SSOT (Single Source of Truth)**: `TypeMappingRegistry`ë¥¼ í†µí•´ C# â†” SQL íƒ€ì… ë§¤í•‘ ê·œì¹™ì„ ë‹¨ì¼í™”í–ˆìŠµë‹ˆë‹¤.
4.  **FullyQualified Reliability**: ëª¨ë“  íƒ€ì… ì°¸ì¡°ì— `global::`ì„ ê°•ì œí•˜ì—¬ ë„¤ì„ìŠ¤í˜ì´ìŠ¤ ì¶©ëŒì„ ì›ì²œ ì°¨ë‹¨í–ˆìŠµë‹ˆë‹¤.
5.  **Modern .NET 10 Support**: `DateOnly`, `TimeOnly`, `Half`, `Primary Constructors`, `Collection Expressions` ë“± ìµœì‹  ë¬¸ë²•ì„ ì™„ë²½ ì§€ì›í•©ë‹ˆë‹¤.

---

## ğŸ¤– AI ì—ì´ì „íŠ¸ ë””ë²„ê¹… ë‚´ë¹„ê²Œì´í„° (For AI Agents)

ì—ì´ì „íŠ¸ê°€ ìƒì„±ëœ ì½”ë“œë¥¼ ë¶„ì„í•˜ê±°ë‚˜ ë””ë²„ê¹…í•  ë•Œ ë‹¤ìŒ ê·œì¹™ì„ ë”°ë¥´ì‹­ì‹œì˜¤.

### 1. ìƒì„±ëœ ì½”ë“œì˜ ìœ„ì¹˜ (Physical Path)

ëª¨ë“  ìƒì„±ëœ ì½”ë“œëŠ” `obj` í´ë” ë‚´ì— ìœ„ì¹˜í•©ë‹ˆë‹¤. `filesystem` ë„êµ¬ë¥¼ ì‚¬ìš©í•˜ì—¬ ë‹¤ìŒ ê²½ë¡œë¥¼ í™•ì¸í•˜ì‹­ì‹œì˜¤.

*   **TVP Accessor**: `obj/Debug/net10.0/generated/Lib.Db.TvpGen/Lib.Db.TvpGen.TvpAccessorGenerator/`
    *   íŒŒì¼ëª… í˜•ì‹: `TvpRegistry_{Namespace}_{ClassName}_TvpRegistry.g.cs`
*   **Result Accessor**: `obj/Debug/net10.0/generated/Lib.Db.TvpGen/Lib.Db.TvpGen.ResultAccessorGenerator/`
    *   íŒŒì¼ëª… í˜•ì‹: `ResultRegistry_{Namespace}_{ClassName}_ResultRegistry.g.cs`

### 2. ìŠ¤ëƒ…ìƒ· í† í° ê³„ì•½ (Token Contract)

ìƒì„±ëœ íŒŒì¼ì˜ í—¤ë”ì—ëŠ” ê¸°ëŠ¥ ë™ì‘ì„ ë³´ì¦í•˜ëŠ” í† í°ì´ í¬í•¨ë˜ì–´ ìˆìŠµë‹ˆë‹¤. ë³€ê²½ ì‚¬í•­ ê²€ì¦ ì‹œ ì´ í† í°ì„ í™•ì¸í•˜ì‹­ì‹œì˜¤.

```csharp
// <auto-generated/>
// TVPGEN:TVP:TRACK5              <-- Track 5 ì•Œê³ ë¦¬ì¦˜ ì‚¬ìš© ì—¬ë¶€
// TVPGEN:ALGO:2025-12-18          <-- ì•Œê³ ë¦¬ì¦˜ ë²„ì „
// TVPGEN:DATETIME_TYPE:DateTime2  <-- DateTime ë§¤í•‘ ì „ëµ (DateTime vs DateTime2)
```

### 3. ì£¼ìš” ì—ëŸ¬ ì½”ë“œ (Troubleshooting)

| Error ID | ì›ì¸ | í•´ê²° ë°©ë²• (Genius Solution) |
| :--- | :--- | :--- |
| **TVP001** | ì œë„¤ë¦­ íƒ€ì… ì‚¬ìš© | ì œë„¤ë¦­ì„ ì œê±°í•˜ê±°ë‚˜ êµ¬ì²´ì ì¸ í´ë˜ìŠ¤ë¡œ ìƒì†ë°›ì•„ ì‚¬ìš©í•˜ì‹­ì‹œì˜¤. |
| **TVP004** | ì§€ì›ë˜ì§€ ì•ŠëŠ” íƒ€ì… | `TypeMappingRegistry`ì— ì •ì˜ëœ íƒ€ì…(int, string, DateTime ë“±)ë§Œ ì‚¬ìš©í•˜ì‹­ì‹œì˜¤. `Int128` ë“±ì€ ì§€ì›ë˜ì§€ ì•ŠìŠµë‹ˆë‹¤. |
| **RES001** | `partial` ëˆ„ë½ | DTO í´ë˜ìŠ¤ ë° ìƒìœ„ í´ë˜ìŠ¤ì— `partial` í‚¤ì›Œë“œë¥¼ ì¶”ê°€í•˜ì‹­ì‹œì˜¤. |
| **RES007** | `struct` ì‚¬ìš© ì‹œë„ | `Lib.Db`ëŠ” `class` ë˜ëŠ” `record class`ë§Œ ì§€ì›í•©ë‹ˆë‹¤. `struct`ë¥¼ `class`ë¡œ ë³€ê²½í•˜ì‹­ì‹œì˜¤. |

---

## ğŸ› ï¸ ì‹œì‘í•˜ê¸° (Getting Started)

### 1. TVP DTO ì •ì˜ (Input)

SQL Serverì˜ í…Œì´ë¸” ë°˜í™˜ ë§¤ê°œë³€ìˆ˜(TVP)ë¡œ ë°ì´í„°ë¥¼ ì „ì†¡í•  ë•Œ ì‚¬ìš©í•©ë‹ˆë‹¤.

```csharp
using Lib.Db.Contracts.Models;

namespace MyApp.Features.Products;

// [TvpRow]: TVP ë§¤í•‘ í™œì„±í™”
// UseDatetime2 = true: ê³ ì •ë°€ ë‚ ì§œ/ì‹œê°„ ì‚¬ìš© (SQL Server 2008+)
[TvpRow(TypeName = "dbo.T_Product_V2", UseDatetime2 = true)]
public record ProductRow
{
    public int ProductId { get; init; }
    public string Name { get; init; } = "";
    public decimal Price { get; init; }
    public DateTime CreatedAt { get; init; }
}
```

### 2. Result DTO ì •ì˜ (Output)

`DataReader`ë¡œë¶€í„° ë°ì´í„°ë¥¼ ì¡°íšŒí•  ë•Œ ì‚¬ìš©í•©ë‹ˆë‹¤. **ë°˜ë“œì‹œ `partial`ì´ì–´ì•¼ í•©ë‹ˆë‹¤.**

```csharp
using Lib.Db.Contracts.Mapping;

namespace MyApp.Features.Products;

// [DbResult]: ê²°ê³¼ ë§¤í•‘ í™œì„±í™”
// partial: ì†ŒìŠ¤ ì œë„ˆë ˆì´í„°ê°€ íŒŒì‹± ë¡œì§ì„ í™•ì¥í•¨
[DbResult]
public partial record ProductDto
{
    public required int Id { get; init; }
    public required string Name { get; init; }
    public string? Description { get; init; }
    
    // ê¸°ë³¸ ìƒì„±ì í•„ìˆ˜ (ë§¤í•‘ ì†ë„ ìµœì í™”)
    public ProductDto() { }
}
```

### 3. ì‚¬ìš© ì˜ˆì‹œ (Usage)

```csharp
// 1. TVP ì „ì†¡
var products = new List<ProductRow>
{
    new() { ProductId = 1, Name = "Laptop", Price = 1200.00m, CreatedAt = DateTime.UtcNow },
    new() { ProductId = 2, Name = "Mouse", Price = 25.50m, CreatedAt = DateTime.UtcNow }
};

await db.Procedure("dbo.usp_InsertProducts")
        .WithTvp("Products", products) // ìë™ ë§¤í•‘ ë° ì „ì†¡
        .ExecuteAsync();

// 2. ì¡°íšŒ (Zero-Allocation Mapping)
var results = await db.Procedure("dbo.usp_GetProducts")
                      .QueryAsync<ProductDto>(); // ìë™ ê³ ì† ë§¤í•‘
```

---

### 3-1. JSON Schema íƒ€ì… ë ˆí¼ëŸ°ìŠ¤ (Complete Type Mapping)

`libdb.schema.json`ì—ì„œ ì‚¬ìš© ê°€ëŠ¥í•œ ëª¨ë“  íƒ€ì… ëª©ë¡ì…ë‹ˆë‹¤. TypeMappingRegistry ê¸°ë°˜ìœ¼ë¡œ C# â†” JSON â†” SQL Server íƒ€ì…ì´ ìë™ ë§¤í•‘ë©ë‹ˆë‹¤.

#### ê¸°ë³¸ íƒ€ì… (Primitive Types)

| JSON Type | SQL Server Type | C# Type | Reader API | ë¹„ê³  |
|:---|:---|:---|:---|:---|
| `Bit` | BIT | `bool` | `GetBoolean()` | True/False |
| `TinyInt` | TINYINT | `byte` | `GetByte()` | 0-255 |
| `SmallInt` | SMALLINT | `short` | `GetInt16()` | -32,768 ~ 32,767 |
| `Int` | INT | `int` | `GetInt32()` | ê°€ì¥ ì¼ë°˜ì  |
| `BigInt` | BIGINT | `long` | `GetInt64()` | í° ì •ìˆ˜ |
| `Real` | REAL | `float` | `GetFloat()` | ë‹¨ì •ë°€ë„ (4 bytes) |
| `Float` | FLOAT | `double` | `GetDouble()` | ë°°ì •ë°€ë„ (8 bytes) |
| `Decimal` | DECIMAL(18,2) | `decimal` | `GetDecimal()` | Precision/Scale ì§€ì • ê°€ëŠ¥ |
| `NVarChar` | NVARCHAR(MAX) | `string` | `GetString()` | ìœ ë‹ˆì½”ë“œ ë¬¸ìì—´ |
| `VarBinary` | VARBINARY(MAX) | `byte[]` | - | ì´ì§„ ë°ì´í„° |

#### ë‚ ì§œ/ì‹œê°„ íƒ€ì… (Date/Time Types)

| JSON Type | SQL Server Type | C# Type | Reader API | .NET ë²„ì „ |
|:---|:---|:---|:---|:---|
| `DateTime` | DATETIME | `DateTime` | `GetDateTime()` | ê¸°ë³¸ê°’ (SQL 2005+) |
| `DateTime2` | DATETIME2(7) | `DateTime` | `GetDateTime()` | ê¶Œì¥ (SQL 2008+) |
| `DateTimeOffset` | DATETIMEOFFSET | `DateTimeOffset` | `GetFieldValue<>()` | íƒ€ì„ì¡´ í¬í•¨ |
| `Date` | DATE | `DateOnly` | `GetFieldValue<>()` | .NET 6+ |
| `Time` | TIME | `TimeOnly` / `TimeSpan` | `GetFieldValue<>()` | .NET 6+ |

#### ê³ ê¸‰ íƒ€ì… (Advanced Types)

| JSON Type | SQL Server Type | C# Type | Reader API | ë¹„ê³  |
|:---|:---|:---|:---|:---|
| `UniqueIdentifier` | UNIQUEIDENTIFIER | `Guid` | `GetGuid()` | UUID |
| `Real` (Half) | REAL | `Half` | `GetFieldValue<>()` | .NET 5+, ë°˜ì •ë°€ë„ |

#### JSON Schema ì˜ˆì œ

**ê¸°ë³¸ íƒ€ì…**:
```json
{
  "Tvps": {
    "dbo.T_User": [
      { "Name": "Id", "Type": "Int" },
      { "Name": "Name", "Type": "NVarChar" },
      { "Name": "IsActive", "Type": "Bit" },
      { "Name": "Age", "Type": "TinyInt" },
      { "Name": "CreatedAt", "Type": "DateTime2" }
    ]
  }
}
```

**Decimal Precision**:
```json
{
  "Tvps": {
    "dbo.T_Transaction": [
      { "Name": "Amount", "Type": "Decimal", "Precision": 18, "Scale": 2 }
    ]
  }
}
```

> [!WARNING]
> **ë¯¸ì§€ì› íƒ€ì…**: `Int128`, `UInt128` (SQL Server ë„¤ì´í‹°ë¸Œ íƒ€ì… ì—†ìŒ)

---

### 4. DB-First DTO ìë™ ìƒì„± (Option)

ì´ë¯¸ ë°ì´í„°ë² ì´ìŠ¤ ìŠ¤í‚¤ë§ˆê°€ í™•ì •ë˜ì–´ ìˆë‹¤ë©´, `libdb.schema.json` íŒŒì¼ì„ í†µí•´ DTOë¥¼ ìë™ ìƒì„±í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

**1. libdb.schema.json ì‘ì„±**:
`libdb.schema.json`ì„ í”„ë¡œì íŠ¸ ë£¨íŠ¸ì— ì¶”ê°€í•˜ê³  ì†ì„±ì„ `AdditionalFiles`ë¡œ ì„¤ì •í•´ì•¼ í•©ë‹ˆë‹¤.

```json
{
  "Tvps": {
    "dbo.T_Product": [
      { "Name": "Id", "Type": "Int" },
      { "Name": "Name", "Type": "NVarChar" }
    ]
  }
}
```

**2. DTO ë§ˆí‚¹**:

```csharp
using Lib.Db.Contracts.Models;

namespace MyApp.Models;

// ìŠ¤í‚¤ë§ˆì— ì •ì˜ëœ "dbo.T_Product"ë¥¼ ê¸°ë°˜ìœ¼ë¡œ ì†ì„± ìë™ ìƒì„±
[GenerateTvpFromDb(TvpName = "dbo.T_Product")]
public partial class ProductRow 
{
    // ë³¸ë¬¸ì€ ë¹„ì›Œë‘¡ë‹ˆë‹¤. ì œë„ˆë ˆì´í„°ê°€ ì±„ì›Œì¤ë‹ˆë‹¤.
}
```

> [!NOTE]
> **Runtime JSON vs Db-First Generator**
> *   **Lib.Db.TvpGen (Db-First)**: **ë””ìì¸ íƒ€ì„**ì— DB ìŠ¤í‚¤ë§ˆ(JSON)ë¥¼ ì½ì–´ **C# ì½”ë“œ(DTO)**ë¥¼ ìƒì„±í•©ë‹ˆë‹¤.
> *   **Lib.Db (System.Text.Json)**: **ëŸ°íƒ€ì„**ì— ê°ì²´ë¥¼ JSONìœ¼ë¡œ ì§ë ¬í™”í•˜ê¸° ìœ„í•œ **AOT í˜¸í™˜ ì½”ë“œ**ë¥¼ ìƒì„±í•©ë‹ˆë‹¤.
> ë‘ ê¸°ëŠ¥ì€ ì„œë¡œ ë‹¤ë¥¸ ëª©ì ì„ ê°€ì§‘ë‹ˆë‹¤.

---

## ğŸ—ï¸ ì•„í‚¤í…ì²˜ ìƒì„¸ (Internal Mechanics)

### TypeMappingRegistry (SSOT)

`Lib.Db.TvpGen`ì˜ ëª¨ë“  íƒ€ì… ë§¤í•‘ ë¡œì§ì€ `TypeMappingRegistry` í´ë˜ìŠ¤ë¡œ ì¤‘ì•™í™”ë˜ì–´ ìˆìŠµë‹ˆë‹¤. ì´ëŠ” `TvpAccessorGenerator`ì™€ `ResultAccessorGenerator`ê°€ ì™„ë²½í•˜ê²Œ ë™ì¼í•œ ë§¤í•‘ ê·œì¹™ì„ ë”°ë¥´ë„ë¡ ë³´ì¥í•©ë‹ˆë‹¤.

*   **FullyQualifiedFormat**: ëª¨ë“  íƒ€ì…ì€ `global::System.Int32`ì™€ ê°™ì´ ì™„ì „ ìˆ˜ì‹ëª…ìœ¼ë¡œ ì²˜ë¦¬ë˜ì–´, ì‚¬ìš©ì ì •ì˜ íƒ€ì…ê³¼ì˜ ì¶©ëŒì„ ë°©ì§€í•©ë‹ˆë‹¤.
*   **DateTime2 Policy**: ì‚¬ìš©ìê°€ ëª…ì‹œì ìœ¼ë¡œ `UseDatetime2 = true`ë¥¼ ì„¤ì •í•˜ì§€ ì•ŠëŠ” í•œ, ê¸°ë³¸ì ìœ¼ë¡œ `DateTime`ìœ¼ë¡œ ë§¤í•‘í•˜ì—¬ í•˜ìœ„ í˜¸í™˜ì„±ì„ ìœ ì§€í•©ë‹ˆë‹¤.

### UnsafeAccessor & Serialization

`private` í•„ë“œë‚˜ `init-only` í”„ë¡œí¼í‹°ì— ì ‘ê·¼í•˜ê¸° ìœ„í•´ .NET 8+ì˜ `[UnsafeAccessor]` ê¸°ëŠ¥ì„ ì‚¬ìš©í•˜ì—¬ ë¦¬í”Œë ‰ì…˜ ì—†ì´ ê³ ì†ìœ¼ë¡œ ë°ì´í„°ë¥¼ ì£¼ì…í•©ë‹ˆë‹¤. ì´ëŠ” `record` íƒ€ì…ì˜ ë¶ˆë³€ì„±(Immutability)ì„ ìœ ì§€í•˜ë©´ì„œë„ ê³ ì„±ëŠ¥ ë§¤í•‘ì„ ê°€ëŠ¥í•˜ê²Œ í•©ë‹ˆë‹¤.

---

## ğŸ“š ë¬¸ì„œ (Documentation)

ë” ìì„¸í•œ ì •ë³´ëŠ” `docs/` í´ë” ë‚´ì˜ ê°€ì´ë“œë¥¼ ì°¸ì¡°í•˜ì‹­ì‹œì˜¤.

*   ğŸ“‚ **[ì•„í‚¤í…ì²˜ ê°€ì´ë“œ](../../docs/TvpGen/typemapping_architecture.md)**: ë§¤í•‘ ë‚´ë¶€ ë™ì‘ ì›ë¦¬ ë° SSOT ì „ëµ.
*   ğŸ“‚ **[DateTime2 ë§ˆì´ê·¸ë ˆì´ì…˜](../../docs/TvpGen/datetime2_migration_guide.md)**: ì •ë°€í•œ ë‚ ì§œ/ì‹œê°„ ì²˜ë¦¬ë¥¼ ìœ„í•œ ê°€ì´ë“œ.
*   ğŸ“‚ **[ì›Œí¬ìŠ¤ë£¨ (Walkthrough)](../../docs/TvpGen/walkthrough.md)**: ë‹¨ê³„ë³„ êµ¬í˜„ ë° ì‚¬ìš© ì˜ˆì œ.

---

<p align="center">
  Generated by <strong>Lib.Db.TvpGen</strong> for <strong>Productivity & Performance</strong>
</p>
