# TVP ë° Native AOT ê°€ì´ë“œ (TVP & AOT)

<!-- AI_CONTEXT: START -->
<!-- ROLE: DEEP_DIVE -->
<!-- AI_CONTEXT: END -->

`Lib.Db`ëŠ” **Native AOT** í˜¸í™˜ì„±ì„ ìœ„í•´ ëŸ°íƒ€ì„ ë¦¬í”Œë ‰ì…˜(Reflection)ì„ ì „í˜€ ì‚¬ìš©í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤. ëŒ€ì‹  **Source Generator**(`Lib.Db.TvpGen`)ë¥¼ ì‚¬ìš©í•˜ì—¬ ì»´íŒŒì¼ íƒ€ì„ì— í•„ìš”í•œ ì½”ë“œë¥¼ ìƒì„±í•©ë‹ˆë‹¤.

---

## ëª©ì°¨

1. [Native AOTë€?](#1-native-aotë€)
2. [Table-Valued Parameters (TVP) ê¸°ë³¸ ì‚¬ìš©ë²•](#2-table-valued-parameters-tvp-ê¸°ë³¸-ì‚¬ìš©ë²•)
3. [Source Generator ë™ì‘ ì›ë¦¬](#3-source-generator-ë™ì‘-ì›ë¦¬)
4. [ê³ ê¸‰ TVP ì‹œë‚˜ë¦¬ì˜¤](#4-ê³ ê¸‰-tvp-ì‹œë‚˜ë¦¬ì˜¤)
5. [ê²°ê³¼ ë§¤í•‘ (Result Mapping)](#5-ê²°ê³¼-ë§¤í•‘-result-mapping)
6. [.csproj ì„¤ì •](#6-csproj-ì„¤ì •)
7. [íŠ¸ëŸ¬ë¸”ìŠˆíŒ…](#7-íŠ¸ëŸ¬ë¸”ìŠˆíŒ…)

---

## 1. Native AOTë€?

Native AOT(Ahead-of-Time) ì»´íŒŒì¼ì€ .NET ì½”ë“œë¥¼ ë„¤ì´í‹°ë¸Œ ê¸°ê³„ì–´ë¡œ ì§ì ‘ ì»´íŒŒì¼í•©ë‹ˆë‹¤.

*   **ì¥ì **: 
    - ë¹ ë¥¸ ì‹œì‘ ì†ë„ (ìˆ˜ì‹­ ms)
    - ì‘ì€ ë©”ëª¨ë¦¬ ì‚¬ìš©ëŸ‰ (10~50% ê°ì†Œ)
    - ë¦¬ë²„ìŠ¤ ì—”ì§€ë‹ˆì–´ë§ ì–´ë ¤ì›€
    - ìì²´ í¬í•¨ ì‹¤í–‰ íŒŒì¼ (ëŸ°íƒ€ì„ ë¶ˆí•„ìš”)

*   **ì œì•½**: 
    - `System.Reflection.Emit` ì‚¬ìš© ë¶ˆê°€
    - ë™ì  íƒ€ì… ë¡œë”© ë¶ˆê°€
    - ëŒ€ë¶€ë¶„ì˜ ORM(EF Core, Dapper) ì œí•œì  ì§€ì›

`Lib.Db`ëŠ” ì´ ì œì•½ì„ ê·¹ë³µí•˜ê¸° ìœ„í•´ ëª¨ë“  ë§¤í•‘ ì½”ë“œë¥¼ **ë¹Œë“œ ì‹œì ì— ìƒì„±**í•©ë‹ˆë‹¤.

### 1-1. AOT Configuration Strategy (Shadow DTO)

Native AOT í™˜ê²½ì—ì„œ `Microsoft.Extensions.Configuration.Binder`ëŠ” ë¦¬í”Œë ‰ì…˜ ê¸°ë°˜ ë°”ì¸ë”© ì‹œ ë³µì¡í•œ íƒ€ì…(`JsonSerializerOptions`, `IDistributedCache` ë“±)ì„ ë§Œë‚˜ë©´ ê²½ê³ (`SYSLIB1100`)ë¥¼ ë°œìƒì‹œí‚µë‹ˆë‹¤.

`Lib.Db`ëŠ” ì´ë¥¼ í•´ê²°í•˜ê¸° ìœ„í•´ **Shadow DTO íŒ¨í„´**ì„ ì‚¬ìš©í•©ë‹ˆë‹¤:

1.  **Shadow DTO (`LibDbConfig`)**: ì„¤ì • íŒŒì¼(`appsettings.json`)ê³¼ 1:1ë¡œ ë§¤í•‘ë˜ëŠ” ìˆœìˆ˜ ë°ì´í„° í´ë˜ìŠ¤(POCO). AOT ë°”ì¸ë”ê°€ ë¬¸ì œ ì—†ì´ ì²˜ë¦¬í•  ìˆ˜ ìˆëŠ” ê¸°ë³¸ íƒ€ì…ìœ¼ë¡œë§Œ êµ¬ì„±ë©ë‹ˆë‹¤.
2.  **Runtime Options (`LibDbOptions`)**: ì‹¤ì œ ì• í”Œë¦¬ì¼€ì´ì…˜ì—ì„œ ì‚¬ìš©ë˜ëŠ” ê°ì²´. ë³µì¡í•œ ëŸ°íƒ€ì„ ê°ì²´ë¥¼ í¬í•¨í•©ë‹ˆë‹¤.
3.  **AppyTo**: ì‹œì‘ ì‹œì ì— Shadow DTOì˜ ê°’ì„ Runtime Optionsë¡œ ìˆ˜ë™ ë§¤í•‘í•©ë‹ˆë‹¤.

ì´ë¡œì¨ ì‚¬ìš©ìëŠ” ë³µì¡í•œ AOT ì„¤ì • ì—†ì´ë„ `appsettings.json`ì„ ìì—°ìŠ¤ëŸ½ê²Œ ì‚¬ìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

---

## 2. Table-Valued Parameters (TVP) ê¸°ë³¸ ì‚¬ìš©ë²•

SQL Serverì˜ TVP ê¸°ëŠ¥ì„ ì‚¬ìš©í•˜ì—¬ ëŒ€ëŸ‰ì˜ ë°ì´í„°ë¥¼ í•œ ë²ˆì˜ ì™•ë³µ(Round-trip)ìœ¼ë¡œ ì „ì†¡í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

### Step 1: SQL Type ì •ì˜

ë¨¼ì € SQL Serverì— ì‚¬ìš©ì ì •ì˜ í…Œì´ë¸” íƒ€ì…ì„ ìƒì„±í•©ë‹ˆë‹¤.

```sql
CREATE TYPE dbo.Tvp_User AS TABLE
(
    Name NVARCHAR(100),
    Age INT,
    Email NVARCHAR(255)
);
```

### Step 2: DTO ì •ì˜ ë° ì–´íŠ¸ë¦¬ë·°íŠ¸ ì ìš©

`[TvpRow]` ì–´íŠ¸ë¦¬ë·°íŠ¸ë¥¼ í´ë˜ìŠ¤ë‚˜ ë ˆì½”ë“œì— ì ìš©í•©ë‹ˆë‹¤. `TypeName`ì€ SQL Serverì— ì •ì˜ëœ Type ì´ë¦„ê³¼ **ì •í™•íˆ ì¼ì¹˜**í•´ì•¼ í•©ë‹ˆë‹¤.

```csharp
using Lib.Db.Contracts;

[TvpRow(TypeName = "dbo.Tvp_User")]
public record UserDto
{
    [TvpLength(100)] // NVARCHAR í¬ê¸° ì§€ì • í•„ìˆ˜
    public string Name { get; init; } = "";

    public int Age { get; init; }

    [TvpLength(255)]
    public string Email { get; init; } = "";
}
```

### Step 3: ë¹Œë“œ (ì†ŒìŠ¤ ìƒì„±)

í”„ë¡œì íŠ¸ë¥¼ ë¹Œë“œí•˜ë©´ ì†ŒìŠ¤ ì œë„ˆë ˆì´í„°ê°€ ë‹¤ìŒ ì½”ë“œë¥¼ ìë™ìœ¼ë¡œ ìƒì„±í•©ë‹ˆë‹¤:
- `UserDtoTvpBuilder` í´ë˜ìŠ¤
- `IEnumerable<UserDto>`ë¥¼ `SqlParameter`ë¡œ ë³€í™˜í•˜ëŠ” ë¡œì§

**ê°œë°œìê°€ ì§ì ‘ ì‘ì„±í•  í•„ìš” ì—†ìŒ!**

### Step 4: ì¿¼ë¦¬ ì‹¤í–‰

ë³„ë„ì˜ ë©”ì„œë“œ í˜¸ì¶œ ì—†ì´, `.With()`ì— ì „ë‹¬í•˜ëŠ” ê°ì²´ ë‚´ì— `IEnumerable<UserDto>` ë˜ëŠ” ë°°ì—´ì´ ìˆë‹¤ë©´ ìë™ìœ¼ë¡œ TVPë¡œ ë³€í™˜ë©ë‹ˆë‹¤.

```csharp
UserDto[] users = 
[
    new() { Name = "Alice", Age = 25, Email = "alice@example.com" },
    new() { Name = "Bob", Age = 30, Email = "bob@example.com" }
];

// ì €ì¥ í”„ë¡œì‹œì € í˜¸ì¶œ
await db.Default
    .Procedure("dbo.usp_BulkInsertUsers")
    .With(new { Users = users })  // @Users íŒŒë¼ë¯¸í„°ì— TVP ë°”ì¸ë”©
    .ExecuteAsync();
```

---

## 3. Source Generator ë™ì‘ ì›ë¦¬

### 3-1. Roslyn Source Generator

`Lib.Db.TvpGen`ì€ ì»´íŒŒì¼ íƒ€ì„ì— ì‹¤í–‰ë˜ëŠ” **Roslyn Incremental Source Generator**ì…ë‹ˆë‹¤.

**ë™ì‘ íë¦„**:
1. ì»´íŒŒì¼ëŸ¬ê°€ `[TvpRow]` ì–´íŠ¸ë¦¬ë·°íŠ¸ê°€ ì ìš©ëœ í´ë˜ìŠ¤ ê°ì§€
2. Source Generatorê°€ í•´ë‹¹ í´ë˜ìŠ¤ì˜ ë©”íƒ€ë°ì´í„° ë¶„ì„
3. TVP ë°”ì¸ë”© ì½”ë“œ ìë™ ìƒì„±
4. ìƒì„±ëœ ì½”ë“œê°€ ì»´íŒŒì¼ì— í¬í•¨

### 3-2. ìƒì„±ëœ ì½”ë“œ ì˜ˆì‹œ

`UserDto`ì— ëŒ€í•´ ë‹¤ìŒê³¼ ê°™ì€ ì½”ë“œê°€ ìƒì„±ë©ë‹ˆë‹¤:

```csharp
// Auto-generated by Lib.Db.TvpGen
namespace Lib.Db.Generated
{
    internal static class UserDtoTvpBuilder
    {
        public static SqlParameter CreateParameter(
            string parameterName, 
            IEnumerable<UserDto> rows)
        {
            var dataTable = new DataTable();
            dataTable.Columns.Add("Name", typeof(string));
            dataTable.Columns.Add("Age", typeof(int));
            dataTable.Columns.Add("Email", typeof(string));

            foreach (var row in rows)
            {
                dataTable.Rows.Add(row.Name, row.Age, row.Email);
            }

            return new SqlParameter
            {
                ParameterName = parameterName,
                SqlDbType = SqlDbType.Structured,
                TypeName = "dbo.Tvp_User",
                Value = dataTable
            };
        }
    }
}
```

### 3-3. í™•ì¸ ë°©ë²•

ìƒì„±ëœ ì½”ë“œëŠ” `obj/<Configuration>/<TargetFramework>/generated/` í´ë”ì—ì„œ í™•ì¸í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

```bash
# ìƒì„±ëœ íŒŒì¼ í™•ì¸
ls obj/Debug/net10.0/generated/Lib.Db.TvpGen/
```

---

## 4. ê³ ê¸‰ TVP ì‹œë‚˜ë¦¬ì˜¤

### 4-1. Nullable í•„ë“œ ì²˜ë¦¬

```csharp
[TvpRow(TypeName = "dbo.Tvp_UserWithOptional")]
public record UserWithOptionalFields
{
    [TvpLength(100)]
    public string Name { get; init; } = "";

    public int? Age { get; init; }  // Nullable<int>

    [TvpLength(255)]
    public string? Email { get; init; }  // Nullable ì°¸ì¡°
}
```

**SQL Type ì •ì˜**:
```sql
CREATE TYPE dbo.Tvp_UserWithOptional AS TABLE
(
    Name NVARCHAR(100),
    Age INT NULL,           -- NULL í—ˆìš©
    Email NVARCHAR(255) NULL
);
```

**ì‚¬ìš©**:
```csharp
var users = new[]
{
    new UserWithOptionalFields { Name = "Alice", Age = null, Email = null },
    new UserWithOptionalFields { Name = "Bob", Age = 30, Email = "bob@example.com" }
};

await db.Default
    .Procedure("dbo.usp_InsertUsersWithOptional")
    .With(new { Users = users })
    .ExecuteAsync();
```

### 4-2. ë³µì¡í•œ íƒ€ì… ë§¤í•‘ (DateTime, Decimal)

```csharp
[TvpRow(TypeName = "dbo.Tvp_Transaction")]
public record TransactionDto
{
    public long Id { get; init; }

    [TvpPrecision(18, 2)]  // decimal(18,2)
    public decimal Amount { get; init; }

    public DateTime CreatedAt { get; init; }

    public DateTimeOffset? ProcessedAt { get; init; }

    public Guid CorrelationId { get; init; }
}
```

**SQL Type**:
```sql
CREATE TYPE dbo.Tvp_Transaction AS TABLE
(
    Id BIGINT,
    Amount DECIMAL(18, 2),
    CreatedAt DATETIME2,
    ProcessedAt DATETIMEOFFSET NULL,
    CorrelationId UNIQUEIDENTIFIER
);
```

### 4-3. TVPì™€ ì¼ë°˜ íŒŒë¼ë¯¸í„° í˜¼í•© ì‚¬ìš©

```csharp
[TvpRow(TypeName = "dbo.Tvp_OrderItem")]
public record OrderItemDto(int ProductId, int Quantity, decimal Price);

// TVP + ìŠ¤ì¹¼ë¼ íŒŒë¼ë¯¸í„°
await db.Default
    .Procedure("dbo.usp_CreateOrder")
    .With(new
    {
        CustomerId = 123,                   // ì¼ë°˜ íŒŒë¼ë¯¸í„°
        OrderDate = DateTime.Now,           // ì¼ë°˜ íŒŒë¼ë¯¸í„°
        Items = orderItems                  // TVP íŒŒë¼ë¯¸í„°
    })
    .ExecuteScalarAsync<int>();  // ìƒì„±ëœ OrderId ë°˜í™˜
```

### 4-4. ëŒ€ëŸ‰ TVP (1ë§Œ ê±´ ì´ìƒ)

```csharp
// 100ë§Œ ê±´ ë°ì´í„° ì¤€ë¹„
var largeDataset = Enumerable.Range(1, 1_000_000)
    .Select(i => new TransactionDto
    {
        Id = i,
        Amount = i * 10.5m,
        CreatedAt = DateTime.Now,
        ProcessedAt = null,
        CorrelationId = Guid.NewGuid()
    });

// ë©”ëª¨ë¦¬ íš¨ìœ¨ì ìœ¼ë¡œ ì²˜ë¦¬
await db.Default
    .Procedure("dbo.usp_BulkInsertTransactions")
    .WithTimeout(600)  // 10ë¶„ íƒ€ì„ì•„ì›ƒ
    .With(new { Transactions = largeDataset })
    .ExecuteAsync();
```

**ì„±ëŠ¥ íŒ**:
- TVPëŠ” ë‚´ë¶€ì ìœ¼ë¡œ `SqlBulkCopy`ë³´ë‹¤ ëŠë¦´ ìˆ˜ ìˆìŒ
- 10ë§Œ ê±´ ì´ìƒì€ `BulkInsertAsync` ì‚¬ìš© ê³ ë ¤
- ì¸ë±ìŠ¤ê°€ ë§ì€ í…Œì´ë¸”ì€ ì‚¬ì „ ë¹„í™œì„±í™”

### 4-5. TVP ì„±ëŠ¥ ìµœì í™”

```csharp
// âŒ ë¹„íš¨ìœ¨: ë§¤ë²ˆ ToList() í˜¸ì¶œ
var users = GetUsersFromDb().ToList();
await db.Default.Procedure("usp_Process").With(new { Users = users }).ExecuteAsync();

// âœ… íš¨ìœ¨: IEnumerable<T> ì§ì ‘ ì „ë‹¬ (ì§€ì—° ì‹¤í–‰)
var users = GetUsersFromDb();  // IEnumerable<UserDto>
await db.Default.Procedure("usp_Process").With(new { Users = users }).ExecuteAsync();
```

**ë‚´ë¶€ ë™ì‘**:
- Source Generatorê°€ `IEnumerable<T>`ë¥¼ ìŠ¤íŠ¸ë¦¬ë° ë°©ì‹ìœ¼ë¡œ `DataTable`ì— ì¶”ê°€
- ë©”ëª¨ë¦¬ì— ì „ì²´ ë°ì´í„°ë¥¼ ë¯¸ë¦¬ ë¡œë“œí•˜ì§€ ì•ŠìŒ

---

## 5. ê²°ê³¼ ë§¤í•‘ (Result Mapping)

ì¿¼ë¦¬ ê²°ê³¼(`SELECT`)ë¥¼ ê°ì²´ë¡œ ë§¤í•‘í•  ë•Œë„ ì†ŒìŠ¤ ì œë„ˆë ˆì´í„°ê°€ ì‚¬ìš©ë©ë‹ˆë‹¤. 

### 5-1. ê¸°ë³¸ ë§¤í•‘

ë³„ë„ì˜ ì–´íŠ¸ë¦¬ë·°íŠ¸ê°€ ì—†ì–´ë„, ì œë„¤ë¦­ ë©”ì„œë“œ `QueryAsync<T>`ê°€ í˜¸ì¶œë˜ë©´ í•´ë‹¹ `T`ì— ëŒ€í•œ ë§¤í¼ê°€ ìƒì„±ë©ë‹ˆë‹¤.

```csharp
public record UserResult(int Id, string Name, string Email);

// ì´ í˜¸ì¶œì„ ê°ì§€í•˜ì—¬ Source Generatorê°€ 'UserResult'ìš© ë§¤í¼ ìƒì„±
var results = await db.Default
    .Sql("SELECT Id, Name, Email FROM Users")
    .QueryAsync<UserResult>()
    .ToListAsync();
```

### 5-2. Partial Class ê¶Œì¥

ë§¤í•‘ ëŒ€ìƒ í´ë˜ìŠ¤ë¥¼ `partial`ë¡œ ì„ ì–¸í•˜ë©´, ìƒì„±ëœ ì½”ë“œê°€ í•´ë‹¹ í´ë˜ìŠ¤ì˜ ë©”ì„œë“œë¡œ ìµœì í™”ë˜ì–´ ë¶™ì„ ìˆ˜ ìˆìŠµë‹ˆë‹¤.

```csharp
public partial record UserResult
{
    public int Id { get; init; }
    public string Name { get; init; } = "";
    public string Email { get; init; } = "";

    // Source Generatorê°€ ì—¬ê¸°ì— ë§¤í•‘ ë©”ì„œë“œ ì¶”ê°€ (ë‚´ë¶€ìš©)
}
```

### 5-3. ì»¬ëŸ¼ëª… ë¶ˆì¼ì¹˜ ì²˜ë¦¬

```csharp
public record ProductDto
{
    [ColumnName("product_id")]  // SQL ì»¬ëŸ¼ëª…ì´ ë‹¤ë¥¼ ê²½ìš°
    public int Id { get; init; }

    [ColumnName("product_name")]
    public string Name { get; init; } = "";

    public decimal Price { get; init; }  // ì´ë¦„ì´ ê°™ìœ¼ë©´ ìë™ ë§¤í•‘
}
```

---

## 6. .csproj ì„¤ì •

### 6-1. í•„ìˆ˜ íŒ¨í‚¤ì§€ ì°¸ì¡°

```xml
<Project Sdk="Microsoft.NET.Sdk">
  <PropertyGroup>
    <TargetFramework>net10.0</TargetFramework>
    <Nullable>enable</Nullable>
    <PublishAot>true</PublishAot>  <!-- Native AOT í™œì„±í™” -->
  </PropertyGroup>

  <ItemGroup>
    <!-- Runtime ë¼ì´ë¸ŒëŸ¬ë¦¬ (All-in-One: Source Generator í¬í•¨) -->
    <PackageReference Include="Lib.Db" Version="x.x.x" />
    <PackageReference Include="Microsoft.Data.SqlClient" Version="6.0.0" />
  </ItemGroup>
</Project>
```

### 6-2. Source Generator ë””ë²„ê¹…

ìƒì„±ëœ ì½”ë“œë¥¼ í”„ë¡œì íŠ¸ì— í¬í•¨í•˜ë ¤ë©´:

```xml
<PropertyGroup>
  <EmitCompilerGeneratedFiles>true</EmitCompilerGeneratedFiles>
  <CompilerGeneratedFilesOutputPath>$(BaseIntermediateOutputPath)Generated</CompilerGeneratedFilesOutputPath>
</PropertyGroup>

<ItemGroup>
  <!-- ìƒì„±ëœ íŒŒì¼ì„ Gitì—ì„œ ì œì™¸ -->
  <None Include="$(CompilerGeneratedFilesOutputPath)/**/*.cs" />
</ItemGroup>
```

### 6-3. Native AOT ë¹Œë“œ

```bash
# AOT ë¹Œë“œ (Windows)
dotnet publish -c Release -r win-x64

# AOT ë¹Œë“œ (Linux)
dotnet publish -c Release -r linux-x64

# ìƒì„±ëœ ì‹¤í–‰ íŒŒì¼ í™•ì¸
ls bin/Release/net10.0/win-x64/publish/
# MyApp.exe (ë‹¨ì¼ ì‹¤í–‰ íŒŒì¼, ì•½ 10~30MB)
```

---

## 7. íŠ¸ëŸ¬ë¸”ìŠˆíŒ…

### Q1. "Metadata not found" ì˜¤ë¥˜ê°€ ë°œìƒí•´ìš”

**ì¦ìƒ**:
```
error CS0246: The type or namespace name 'UserDtoTvpBuilder' could not be found
```

**ì›ì¸**: `Lib.Db` íŒ¨í‚¤ì§€ê°€ ì„¤ì¹˜ë˜ì§€ ì•Šì•˜ê±°ë‚˜ Source Generatorê°€ IDEì—ì„œ ê°±ì‹ ë˜ì§€ ì•ŠìŒ.

**í•´ê²°**:
1.  **íŒ¨í‚¤ì§€ í™•ì¸**:
    ```bash
    dotnet list package | grep Lib.Db
    ```

2. Clean & Rebuild:
   ```bash
   dotnet clean
   dotnet build
   ```

3. IDE ì¬ì‹œì‘ (VS Code, Visual Studio)

### Q2. TVP TypeName ë¶ˆì¼ì¹˜ ì˜¤ë¥˜

**ì¦ìƒ**:
```sql
Msg 215, Level 16, State 1
Parameters supplied for object 'dbo.usp_InsertUsers' which is not a function.
```

**ì›ì¸**: `[TvpRow(TypeName = "...")]`ì˜ ê°’ì´ SQL Serverì˜ ì‹¤ì œ Type ì´ë¦„ê³¼ ë‹¤ë¦„.

**í•´ê²°**:
```sql
-- SQL Serverì— ì •ì˜ëœ Type í™•ì¸
SELECT name, type_desc 
FROM sys.types 
WHERE is_table_type = 1;
```

TypeNameì„ ì •í™•íˆ ì¼ì¹˜ì‹œí‚¤ì„¸ìš” (ìŠ¤í‚¤ë§ˆ í¬í•¨):
```csharp
[TvpRow(TypeName = "dbo.Tvp_User")]  // âœ… ìŠ¤í‚¤ë§ˆ í¬í•¨
[TvpRow(TypeName = "Tvp_User")]      // âŒ ìŠ¤í‚¤ë§ˆ ì—†ìœ¼ë©´ dboë¡œ ê°„ì£¼ë˜ì§€ë§Œ ëª…ì‹œ ê¶Œì¥
```

### Q3. Nullable í•„ë“œê°€ DBNullë¡œ ì²˜ë¦¬ë˜ì§€ ì•Šì•„ìš”

**ì¦ìƒ**: `null` ê°’ì´ SQLì—ì„œ `NULL`ì´ ì•„ë‹Œ ê¸°ë³¸ê°’ìœ¼ë¡œ ì €ì¥ë¨.

**í•´ê²°**: DTOì™€ SQL Type ëª¨ë‘ NULL í—ˆìš©í•´ì•¼ í•¨:

```csharp
public int? Age { get; init; }  // C#ì—ì„œ Nullable
```

```sql
CREATE TYPE dbo.Tvp_User AS TABLE
(
    Age INT NULL  -- SQLì—ì„œë„ NULL í—ˆìš©
);
```

### Q4. AOT ë¹Œë“œ ì‹œ ê²½ê³ ê°€ ëœ¨ë‚˜ìš”?

**ê²½ê³  ì˜ˆì‹œ**:
```
IL2026: Using member '...' which has 'RequiresUnreferencedCodeAttribute' can break functionality when trimming application code.
```

**ì›ì¸**: `Lib.Db` ë‚´ë¶€ ì½”ë“œì—ì„œëŠ” AOT ê²½ê³ ê°€ **ë°œìƒí•˜ì§€ ì•Šì•„ì•¼** í•©ë‹ˆë‹¤. ë§Œì•½ ì‚¬ìš©ì ì½”ë“œì—ì„œ ë¦¬í”Œë ‰ì…˜ì„ ì‚¬ìš©í•œë‹¤ë©´ ê²½ê³  ë°œìƒ ê°€ëŠ¥.

**í•´ê²°**:
- `Lib.Db` ì‚¬ìš© ì‹œ ë¦¬í”Œë ‰ì…˜ ê¸ˆì§€
- DTOëŠ” ëª¨ë‘ Source Generatorë¡œ ì²˜ë¦¬
- Dynamic Type ì‚¬ìš© ê¸ˆì§€

### Q5. ìƒì„±ëœ ì½”ë“œë¥¼ í™•ì¸í•˜ê³  ì‹¶ì–´ìš”

**ë°©ë²• 1**: obj í´ë” í™•ì¸
```bash
# Windows
dir obj\Debug\net10.0\generated\Lib.Db.TvpGen\

# Linux/macOS
ls obj/Debug/net10.0/generated/Lib.Db.TvpGen/
```

**ë°©ë²• 2**: EmitCompilerGeneratedFiles ì„¤ì •
```xml
<PropertyGroup>
  <EmitCompilerGeneratedFiles>true</EmitCompilerGeneratedFiles>
</PropertyGroup>
```

ë¹Œë“œ í›„ `obj/Generated/` í´ë”ì—ì„œ í™•ì¸ ê°€ëŠ¥.

### Q6. ì„±ëŠ¥ì´ ê¸°ëŒ€ë³´ë‹¤ ëŠë ¤ìš”

**ì²´í¬ë¦¬ìŠ¤íŠ¸**:
1. **ì¸ë±ìŠ¤**: TVP ëŒ€ìƒ í…Œì´ë¸”ì— ì ì ˆí•œ ì¸ë±ìŠ¤ ì¡´ì¬?
2. **ë°ì´í„°ëŸ‰**: 10ë§Œ ê±´ ì´ìƒì´ë©´ `BulkInsertAsync` ì‚¬ìš© ê³ ë ¤
3. **ë„¤íŠ¸ì›Œí¬**: ëŒ€ëŸ‰ ë°ì´í„°ëŠ” ì••ì¶• ì˜µì…˜ ê³ ë ¤
4. **íƒ€ì„ì•„ì›ƒ**: `.WithTimeout(600)` ì„¤ì • í™•ì¸

### Q7. partial í´ë˜ìŠ¤ë¥¼ ì‚¬ìš©í•˜ì§€ ì•Šìœ¼ë©´ ë¬¸ì œê°€ ìˆë‚˜ìš”?

**ë‹µë³€**: ì•„ë‹ˆìš”, `partial`ì€ ì„ íƒì‚¬í•­ì…ë‹ˆë‹¤. 

- `partial` ì‚¬ìš©: ìƒì„±ëœ ì½”ë“œê°€ ê°™ì€ í´ë˜ìŠ¤ì— ë³‘í•©ë˜ì–´ ì•½ê°„ ë” ìµœì í™”
- `partial` ë¯¸ì‚¬ìš©: ë³„ë„ Helper í´ë˜ìŠ¤ë¡œ ìƒì„±, ê¸°ëŠ¥ìƒ ì°¨ì´ ì—†ìŒ

### Q8. ì—¬ëŸ¬ TVPë¥¼ ë™ì‹œì— ì „ë‹¬í•  ìˆ˜ ìˆë‚˜ìš”?

**ë‹µë³€**: ë„¤, ê°€ëŠ¥í•©ë‹ˆë‹¤.

```csharp
await db.Default
    .Procedure("dbo.usp_CreateOrderWithItems")
    .With(new
    {
        Order = new[] { new OrderDto(...) },       // TVP 1
        Items = new[] { new OrderItemDto(...) },   // TVP 2
        Payments = new[] { new PaymentDto(...) }   // TVP 3
    })
    .ExecuteAsync();
```

### Q9. Generic íƒ€ì…ì„ TVPë¡œ ì‚¬ìš©í•  ìˆ˜ ìˆë‚˜ìš”?

**ë‹µë³€**: ì•„ë‹ˆìš”, Source GeneratorëŠ” Generic íƒ€ì…ì„ ì§€ì›í•˜ì§€ ì•ŠìŠµë‹ˆë‹¤.

```csharp
// âŒ ë¶ˆê°€
[TvpRow(TypeName = "...")]
public record GenericDto<T> { public T Value { get; init; } }

// âœ… ê°€ëŠ¥
[TvpRow(TypeName = "...")]
public record ConcreteDto { public int Value { get; init; } }
```

### Q10. ë™ì¼í•œ DTOë¥¼ ì—¬ëŸ¬ TVP Typeì— ë§¤í•‘í•  ìˆ˜ ìˆë‚˜ìš”?

**ë‹µë³€**: ì•„ë‹ˆìš”, í•˜ë‚˜ì˜ DTOëŠ” í•˜ë‚˜ì˜ TVP Typeì—ë§Œ ë§¤í•‘ë©ë‹ˆë‹¤.

**í•´ê²°**: ë³„ë„ DTO ì •ì˜
```csharp
[TvpRow(TypeName = "dbo.Tvp_UserFull")]
public record UserFullDto { /* ëª¨ë“  í•„ë“œ */ }

[TvpRow(TypeName = "dbo.Tvp_UserBasic")]
public record UserBasicDto { /* ID, Nameë§Œ */ }
```

---

## ì¶”ê°€ ë¦¬ì†ŒìŠ¤

- [Microsoft Docs: Source Generators](https://learn.microsoft.com/en-us/dotnet/csharp/roslyn-sdk/source-generators-overview)
- [Native AOT Deployment](https://learn.microsoft.com/en-us/dotnet/core/deploying/native-aot/)
- [SQL Server Table-Valued Parameters](https://learn.microsoft.com/en-us/sql/relational-databases/tables/use-table-valued-parameters-database-engine)

---

ì´ ê°€ì´ë“œë¥¼ ë”°ë¼í•˜ë©´ TVPì™€ Native AOTë¥¼ ì™„ë²½íˆ ì´í•´í•˜ê³  í™œìš©í•  ìˆ˜ ìˆìŠµë‹ˆë‹¤.

---
<p align="center">
  â¬…ï¸ <a href="./03_fluent_api_reference.md">ì´ì „: Fluent API</a>
  &nbsp;|&nbsp;
  <a href="./05_performance_optimization.md">ë‹¤ìŒ: ì„±ëŠ¥ ìµœì í™” â¡ï¸</a>
</p>

<p align="center">
  ğŸ  <a href="../README.md">í™ˆìœ¼ë¡œ</a>
</p>
